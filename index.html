<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>URBAN CASA | Dispatch Dashboard</title>
    <style>
        :root { --header-footer: #000000; --accent: #2563eb; --wa-green: #25D366; --bg: #f8fafc; --danger: #be123c; }
        body { font-family: system-ui, sans-serif; background: var(--bg); margin: 0; padding: 0; color: #1e293b; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: var(--header-footer); padding: 25px 20px; text-align: center; color: white; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        header h1 { margin: 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 3px; font-weight: 900; }
        .container { padding: 15px; flex: 1; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #64748b; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        input:focus { outline: 2px solid var(--accent); border-color: transparent; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn-wa { background: var(--wa-green); color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-wa:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-search { background: var(--accent); color: white; }
        .btn-danger { background: white; color: var(--danger); border: 1px solid var(--danger); font-size: 0.8rem; padding: 8px; }
        .stats { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; font-weight: bold; background: #f1f5f9; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<header>
    <h1>URBAN CASA</h1>
    <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 5px;">DISPATCH DASHBOARD v4.1</div>
</header>

<div class="container">
    <div class="stats">
        <span>üì¶ MONTH TOTAL: <span id="count">0</span></span>
        <span>QC: SUMAN</span>
    </div>

    <div class="card">
        <form id="deliveryForm">
            <div class="row">
                <div class="form-group">
                    <label>Dispatch Date</label>
                    <input type="date" id="dDate" required>
                </div>
                <div class="form-group">
                    <label>Bill Date</label>
                    <input type="date" id="bDate" required>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Bill Number</label>
                    <input type="text" id="bNo" placeholder="Loading...">
                </div>
                <div class="form-group">
                    <label>Quantity (Pkgs)</label>
                    <input type="number" id="qty" placeholder="0" required>
                </div>
            </div>

            <div class="form-group">
                <label>Customer Name</label>
                <input type="text" id="cName" placeholder="Enter name" required>
            </div>

            <div class="form-group">
                <label>Area / Route</label>
                <input type="text" id="area" placeholder="e.g. Jubilee Hills" required>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Payment Due?</label>
                    <select id="due" onchange="toggleAmt()">
                        <option value="No">No (Paid)</option>
                        <option value="Yes">Yes (Due)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Amount (‚Çπ)</label>
                    <input type="number" id="amt" value="0" disabled>
                </div>
            </div>

            <input type="hidden" id="qcCheckedBy" value="Suman">

            <button type="button" class="btn-wa" onclick="saveData()">
                SAVE & WHATSAPP EXPORT
            </button>
        </form>
    </div>

    <div class="card" style="background: transparent; box-shadow: none; padding: 0;">
        <button class="btn-search" onclick="searchBill()">üîç SEARCH BILL</button>
        <button class="btn-danger" onclick="resetMonthlyData()">‚ö†Ô∏è RESET MONTHLY DATA</button>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6_8nr3Ghe661fTCQOxy501LoJI470TcqAa46P59eM8hmxnqXxP4Rdzq3OU67T5Ur9eQ/exec';

    function init() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dDate').value = today;
        document.getElementById('bDate').value = today;
        
        const lastBill = localStorage.getItem('lastBill') || 1001;
        document.getElementById('bNo').value = `UC-${lastBill}`;
        
        const ledger = JSON.parse(localStorage.getItem('monthlyLedger')) || [];
        document.getElementById('count').innerText = ledger.length;
    }

    function toggleAmt() {
        const due = document.getElementById('due').value;
        const amtInput = document.getElementById('amt');
        if(due === 'Yes') {
            amtInput.disabled = false;
            amtInput.value = "";
            amtInput.focus();
        } else {
            amtInput.disabled = true;
            amtInput.value = "0";
        }
    }

    function formatDateDMY(dateStr) {
        if(!dateStr) return "";
        const [y, m, d] = dateStr.split('-');
        return `${d}-${m}-${y}`;
    }

    function saveData() {
        const saveBtn = document.querySelector('.btn-wa');
        const originalText = saveBtn.innerHTML;

        const entry = {
            dispatch: document.getElementById('dDate').value,
            billDate: document.getElementById('bDate').value,
            billNo: document.getElementById('bNo').value,
            name: document.getElementById('cName').value.toUpperCase() || "N/A",
            qty: document.getElementById('qty').value || 0,
            area: document.getElementById('area').value.toUpperCase() || "N/A",
            due: document.getElementById('due').value,
            amt: document.getElementById('amt').value || 0,
            staff: "Suman" // Keeping key as 'staff' for Google Script compatibility, but labeled as QC Checked By
        };

        if(!entry.name || entry.qty == 0) return alert("Please fill Customer and Quantity");

        saveBtn.disabled = true;
        saveBtn.innerHTML = "‚åõ SYNCING TO CLOUD...";

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            cache: 'no-cache',
            body: JSON.stringify(entry)
        })
        .then(() => {
            let ledger = JSON.parse(localStorage.getItem('monthlyLedger')) || [];
            ledger.push(entry);
            localStorage.setItem('monthlyLedger', JSON.stringify(ledger));
            
            const nextNum = (parseInt(entry.billNo.split('-')[1]) || 1000) + 1;
            localStorage.setItem('lastBill', nextNum);

            // UPDATED: WhatsApp Message formatting
            const waMsg = `*URBAN CASA DISPATCH*%0A--------------------------%0A*Date:* ${formatDateDMY(entry.billDate)}%0A*Bill No:* ${entry.billNo}%0A*Customer:* ${entry.name}%0A*Area:* ${entry.area}%0A*Qty:* ${entry.qty} Pkgs%0A*Due:* ${entry.due === 'Yes' ? '‚Çπ' + entry.amt : 'No'}%0A*QC Checked By:* ${entry.staff}%0A--------------------------%0Aüöö _Status: Dispatched_`;
            
            window.open(`https://wa.me/?text=${waMsg}`, '_blank');

            document.getElementById('deliveryForm').reset();
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
            init();
        })
        .catch(err => {
            alert("Sync Error. Data saved locally only.");
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        });
    }

    function searchBill() {
        const num = prompt("Enter Bill Number (e.g., 1001):");
        if(!num) return;
        const ledger = JSON.parse(localStorage.getItem('monthlyLedger')) || [];
        const found = ledger.find(r => r.billNo.includes(num));
        if(found) {
            alert(`FOUND: ${found.name}\nArea: ${found.area}\nQty: ${found.qty}\nDue: ${found.due}\nQC By: ${found.staff}`);
        } else {
            alert("Bill not found in local records.");
        }
    }

    function resetMonthlyData() {
        if(confirm("DELETE ALL LOCAL DATA? This resets bill numbering to 1001.")) {
            if(confirm("Are you REALLY sure?")) {
                localStorage.clear();
                location.reload();
            }
        }
    }

    window.onload = init;
</script>

</body>
</html>